name: Build and Push to Docker Hub

# =============================================================================
# 触发条件
# =============================================================================
# - 推送到 main 分支时自动触发（只执行构建和推送）
# - 针对 main 分支的 Pull Request 会触发构建（但不部署）
# - 可以通过 workflow_dispatch 手动触发
on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'main.py'
      - '**/*.py'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'Dockerfile'
      - '.dockerignore'
  pull_request:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'main.py'
      - '**/*.py'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'Dockerfile'
      - '.dockerignore'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  # 修改为你的 Docker Hub 用户名/镜像名
  IMAGE_NAME: izerui/browser-fetch

# =============================================================================
# 工作流包含一个 Job
# =============================================================================
jobs:
  # -----------------------------------------------------------------------------
  # Job: build-and-push
  # 负责构建 Docker 镜像并推送到 Docker Hub 中央仓库
  # -----------------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    # 1. 检出代码：获取仓库代码和历史记录
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. 设置 Python 环境：使用 Python 3.12
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    # 3. 安装 uv：快速的 Python 包管理器
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    # 4. 安装依赖
    - name: Install dependencies
      run: |
        uv sync --frozen

    # 5. 提取版本号：从 pyproject.toml 中读取项目版本
    - name: Extract project version
      id: project
      run: |
        VERSION=$(uv run python -c "import tomllib; config = tomllib.load(open('pyproject.toml', 'rb')); print(config['project']['version'])")
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Project version: ${VERSION}"

    # 6. 设置 Docker Buildx：启用 Docker 构建缓存和多平台支持
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 7. 登录 Docker Hub：使用配置的凭证登录到 Docker Hub 中央仓库
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # 8. 构建并推送镜像：构建 Docker 镜像并推送到 Docker Hub
    - name: Build and Push Docker Image (amd64)
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.project.outputs.version }}-amd64
        platforms: linux/amd64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ steps.project.outputs.version }}

    # 9. 合并多架构标签
    - name: Create Multi-Archifest
      run: |
        docker buildx imagetools create \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.project.outputs.version }} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.project.outputs.version }}-amd64 \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.project.outputs.version }}-arm64 || true
